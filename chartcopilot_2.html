<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <title>Chart.js 양방향(버터플라이) 혼합형 차트</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            padding: 40px;
            font-family: sans-serif;
        }

        canvas {
            max-width: 800px;
        }
    </style>
</head>

<body>
    <h2>y축 중앙, 양방향 혼합형 차트</h2>
    <canvas id="myChart"></canvas>
    <script>
        // 실제 데이터는 모두 양수로 관리
        const barDataLeftRaw = [0.31, 1.66, 1.21];
        const pointDataLeftRaw = [2.0, 1.2, 0.8];
        const barDataRight = [0.21, 2.66, 2.21];
        const pointDataRight = [1.5, 1.0, 2.0];

        // 차트에 넣을 때만 왼쪽 데이터에 음수 부호를 붙임
        const barDataLeft = barDataLeftRaw.map(v => -v);
        const pointDataLeft = pointDataLeftRaw.map(v => -v);

        // 오류선 플러그인 (방향, 색상 지정)
        function createHorizontalLinePlugin(pointData, barData, color) {
            return {
                id: 'horizontalLinePlugin_' + color,
                afterDatasetsDraw(chart) {
                    const { ctx, scales } = chart;
                    const yAxis = scales.y;
                    const xAxis = scales.x;

                    ctx.save();
                    ctx.strokeStyle = color;
                    ctx.lineWidth = 2;
                    ctx.fillStyle = color;

                    pointData.forEach((value, idx) => {
                        const y = yAxis.getPixelForValue(idx);
                        const x0 = xAxis.getPixelForValue(0);
                        const x = xAxis.getPixelForValue(value);

                        // 수평선(오류선) 그리기: x=0 ~ x=value
                        ctx.beginPath();
                        ctx.moveTo(x0, y);
                        ctx.lineTo(x, y);
                        ctx.stroke();

                        // 끝점(원) 그리기
                        ctx.beginPath();
                        ctx.arc(x, y, 5, 0, 2 * Math.PI);
                        ctx.fill();

                        // 차이값 표시 (수평선 중간)
                        const barValue = barData[idx];
                        const diff = (value - barValue).toFixed(2);
                        const midX = (x + xAxis.getPixelForValue(barValue)) / 2;
                        ctx.save();
                        ctx.font = 'bold 12px sans-serif';
                        ctx.fillStyle = diff >= 0 ? 'green' : 'red';
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'bottom';
                        ctx.fillText(`Δ${diff}`, midX, y - 8);
                        ctx.restore();
                    });

                    ctx.restore();
                }
            };
        }

        const ctx = document.getElementById('myChart').getContext('2d');
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['김', '맞지않음', '작음'],
                datasets: [
                    {
                        type: 'bar',
                        label: '전체 비율 (왼쪽)',
                        data: barDataLeft,
                        backgroundColor: 'rgba(255, 159, 64, 0.4)',
                        borderRadius: 8,
                        barThickness: 24,
                    },
                    {
                        type: 'bar',
                        label: '전체 비율 (오른쪽)',
                        data: barDataRight,
                        backgroundColor: 'rgba(153, 102, 255, 0.4)',
                        borderRadius: 8,
                        barThickness: 24,
                    }
                ]
            },
            options: {
                indexAxis: 'y',
                plugins: {
                    legend: { display: true },
                    tooltip: {
                        callbacks: {
                            label: (context) => `${context.dataset.label}: ${Math.abs(context.raw)}%`
                        }
                    }
                },
                scales: {
                    x: {
                        beginAtZero: true,
                        min: -3,
                        max: 3,
                        title: { display: true, text: '양방향(%)' },
                        ticks: {
                            callback: (value) => `${Math.abs(value)}%`
                        }
                    }
                }
            },
            plugins: [
                createHorizontalLinePlugin(pointDataLeft, barDataLeft, 'orange'),
                createHorizontalLinePlugin(pointDataRight, barDataRight, 'blue')
            ]
        });
    </script>
</body>

</html>