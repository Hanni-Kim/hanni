<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <title>Chart.js 혼합형 차트 예제</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            padding: 40px;
            font-family: sans-serif;
        }
        canvas {
            max-width: 600px;
        }
    </style>
</head>

<body>
    <h2>혼합 차트 (수평 막대 + 오류선/포인트)</h2>
    <canvas id="myChart"></canvas>
    <script>
        const barData = [0.21, 2.66, 2.21];
        const pointData = [1.5, 1.0, 2.0];

        const horizontalLinePlugin = {
            id: 'horizontalLinePlugin',
            afterDatasetsDraw(chart) {
                const { ctx, scales } = chart;
                const yAxis = scales.y;
                const xAxis = scales.x;

                ctx.save();
                ctx.strokeStyle = 'blue';
                ctx.lineWidth = 2;
                ctx.fillStyle = 'blue';

                pointData.forEach((value, idx) => {
                    const y = yAxis.getPixelForValue(idx);
                    const x0 = xAxis.getPixelForValue(0);
                    const x = xAxis.getPixelForValue(value);

                    // 수평선(오류선) 그리기: x=0 ~ x=value
                    ctx.beginPath();
                    ctx.moveTo(x0, y);
                    ctx.lineTo(x, y);
                    ctx.stroke();

                    // 끝점(원) 그리기
                    ctx.beginPath();
                    ctx.arc(x, y, 5, 0, 2 * Math.PI);
                    ctx.fill();

                    // 차이값 표시 (수평선 중간)
                    const barValue = barData[idx];
                    const diff = (value - barValue).toFixed(2);
                    const midX = (x + xAxis.getPixelForValue(barValue)) / 2;
                    ctx.save();
                    ctx.font = 'bold 12px sans-serif';
                    ctx.fillStyle = diff >= 0 ? 'green' : 'red'; // 양수면 초록, 음수면 빨강
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'bottom';
                    ctx.fillText(`Δ${diff}`, midX, y - 8);
                    ctx.restore();
                });

                ctx.restore();
            }
        };

        const ctx = document.getElementById('myChart').getContext('2d');
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['김', '맞지않음', '작음'],
                datasets: [
                    {
                        type: 'bar',
                        label: '전체 비율',
                        data: barData,
                        backgroundColor: 'rgba(153, 102, 255, 0.4)',
                        borderRadius: 8,
                        barThickness: 24,
                    }
                ]
            },
            options: {
                indexAxis: 'y',
                plugins: {
                    legend: { display: true },
                    tooltip: {
                        callbacks: {
                            label: (context) => `${context.dataset.label}: ${context.raw}%`
                        }
                    }
                },
                scales: {
                    x: {
                        beginAtZero: true,
                        ticks: {
                            callback: (value) => `${value}%`
                        }
                    }
                }
            },
            plugins: [horizontalLinePlugin]
        });
    </script>
</body>
</html>